using UnityEngine;

public class EnemyAttack : MonoBehaviour
{
    [Header("Attack Settings")]
    [Tooltip("La cantidad de da침o que este enemigo inflige al jugador.")]
    public float attackDamage = 1f;

    [Tooltip("El tiempo que debe esperar antes de poder volver a infligir da침o (cooldown).")]
    public float attackCooldown = 1.0f; 
    
    // Variables privadas de estado
    private float lastAttackTime;
    private bool isAttacking = false; // 游눠 Controla si la secuencia/animaci칩n de ataque est치 activa
    
    // Referencia al Animator (opcional, pero 칰til para iniciar animaciones)
    // private Animator animator; 

    void Start()
    {
        // animator = GetComponent<Animator>(); // Descomentar si usas un Animator
        Debug.Log("EnemyAttack iniciado - Da침o: " + attackDamage + ", Cooldown: " + attackCooldown);
    }

    /// <summary>
    /// Se llama en el frame que el trigger entra en contacto con otro collider.
    /// </summary>
    private void OnTriggerEnter2D(Collider2D other)
    {
        Debug.Log("Trigger ENTER con: " + other.gameObject.name);
        TryAttack(other);
    }
    
    /// <summary>
    /// Se llama CADA FRAME mientras el trigger est치 en contacto con otro collider.
    /// Esto permite seguir atacando si el jugador se queda quieto sobre el enemigo.
    /// </summary>
    private void OnTriggerStay2D(Collider2D other)
    {
        TryAttack(other);
    }

    /// <summary>
    /// L칩gica central para intentar infligir da침o, respetando el cooldown y el estado de ataque.
    /// </summary>
    private void TryAttack(Collider2D other)
    {
        // 1. NUEVA RESTRICCI칍N: No puede empezar un nuevo ataque si ya est치 en la secuencia de uno.
        if (isAttacking)
        {
            Debug.Log("Ataque pendiente: Ya estamos en la secuencia de ataque.");
            return;
        }

        // 2. Verificar si el objetivo es el jugador y si el cooldown ha terminado.
        if (other.CompareTag("Player") && Time.time > lastAttackTime + attackCooldown)
        {
            Debug.Log("Ataque exitoso a jugador - Cooldown completado. INICIANDO ATAQUE.");
            
            // 3. Establece el estado: Ahora estamos atacando.
            isAttacking = true;
            
            // 4. Inicia la secuencia (llama a la animaci칩n y la l칩gica de da침o)
            StartAttackSequence(other);
        }
        else if (other.CompareTag("Player"))
        {
            Debug.Log("Ataque en cooldown. Tiempo restante: " + (lastAttackTime + attackCooldown - Time.time));
        }
    }

    /// <summary>
    /// Inicia el ataque real: llama a la animaci칩n e inflige el da침o.
    /// </summary>
    private void StartAttackSequence(Collider2D target)
    {
        // 1. **INICIA ANIMACI칍N**: Descomenta y ajusta si usas Animator.
        // if (animator != null)
        // {
        //     animator.SetTrigger("Attack");
        // }

        // 2. Intentamos obtener el sistema de vida del Jugador.
        HealthSystem playerHealth = target.GetComponent<HealthSystem>();

        if (playerHealth != null)
        {
            // 3. Inflige da침o 
            playerHealth.TakeDamage(attackDamage);
            
            // 4. Reinicia el tiempo del 칰ltimo ataque (se reinicia al infligir da침o, no al terminar la animaci칩n)
            lastAttackTime = Time.time; 
            Debug.Log("Da침o infligido. Pr칩ximo ataque permitido (por cooldown) en: " + attackCooldown + " segundos");
        }
        else
        {
            Debug.LogWarning("HealthSystem no encontrado en el jugador.");
            // Si el da침o no se puede aplicar, es buena pr치ctica finalizar el ataque aqu칤 si no hay animaci칩n
            // Pero si la animaci칩n va a correr igual, la terminaci칩n debe esperar a la animaci칩n.
        }

        // 游뚿 IMPORTANTE: La variable 'isAttacking' se restablece a 'false' en el m칠todo p칰blico 'FinishAttack()'
    }

    /// <summary>
    /// M칄TODO P칔BLICO: **Debe ser llamado por un Animation Event** al final de la animaci칩n de ataque.
    /// Esto es lo que "termina" el ataque y permite iniciar el siguiente.
    /// </summary>
    public void FinishAttack()
    {
        isAttacking = false;
        Debug.Log("Secuencia de ataque terminada. El enemigo puede intentar un nuevo ataque ahora (si el cooldown lo permite).");
    }
}
